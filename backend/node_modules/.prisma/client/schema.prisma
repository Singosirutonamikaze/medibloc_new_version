generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  DOCTOR
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum DiseaseStatus {
  ACTIVE
  IN_REMISSION
  CURED
  CHRONIC
}

enum DiseaseSeverity {
  MILD
  MODERATE
  SEVERE
  CRITICAL
}

enum MedicineType {
  PHARMACEUTICAL // Médicament de pharmacie
  HERBAL // Plante médicinale
}

// ============================================
// UTILISATEURS ET PROFILS
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(PATIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patientProfile Patient?
  doctorProfile  Doctor?
  adminProfile   Admin?
}

model Patient {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  birthDate DateTime?
  gender    Gender?
  phone     String?
  address   String?

  // Relations
  diseases       PatientDisease[]
  appointments   Appointment[]
  prescriptions  Prescription[]
  medicalRecords MedicalRecord[]
}

model Doctor {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialty String?
  phone     String?

  // Relations
  appointments  Appointment[]
  prescriptions Prescription[]
}

model Admin {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String?
  createdAt DateTime @default(now())
}

// ============================================
// RENDEZ-VOUS
// ============================================

model Appointment {
  id          Int               @id @default(autoincrement())
  patientId   Int
  patient     Patient           @relation(fields: [patientId], references: [id])
  doctorId    Int
  doctor      Doctor            @relation(fields: [doctorId], references: [id])
  scheduledAt DateTime
  reason      String?
  notes       String?
  status      AppointmentStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

// ============================================
// MALADIES ET SYMPTÔMES
// ============================================

// Catalogue des maladies (pré-rempli par seed ou ajouté par admin)
model Disease {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  isViral     Boolean @default(false)
  isBacterial Boolean @default(false)
  isGenetic   Boolean @default(false)
  isChronic   Boolean @default(false)

  // Relations
  symptoms           DiseaseSymptom[]
  prevalentCountries DiseaseCountry[]
  patientDiseases    PatientDisease[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Catalogue des symptômes
model Symptom {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  diseaseSymptoms DiseaseSymptom[]
  patientSymptoms PatientSymptom[]
  createdAt       DateTime         @default(now())
}

// Relation entre maladie et symptômes
model DiseaseSymptom {
  id        Int     @id @default(autoincrement())
  disease   Disease @relation(fields: [diseaseId], references: [id], onDelete: Cascade)
  diseaseId Int
  symptom   Symptom @relation(fields: [symptomId], references: [id], onDelete: Cascade)
  symptomId Int
  isCommon  Boolean @default(true) // Symptôme fréquent ou rare

  @@unique([diseaseId, symptomId])
}

// Pays où les maladies sont prévalentes
model Country {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  code            String           @unique // Code ISO (ex: FR, TG, US)
  continent       String
  diseasesPresent DiseaseCountry[]
  pharmacies      Pharmacy[]
  createdAt       DateTime         @default(now())
}

// Relation entre maladie et pays
model DiseaseCountry {
  id             Int     @id @default(autoincrement())
  disease        Disease @relation(fields: [diseaseId], references: [id], onDelete: Cascade)
  diseaseId      Int
  country        Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  countryId      Int
  prevalenceRate Float? // Taux de prévalence (%)
  isEndemic      Boolean @default(false)

  @@unique([diseaseId, countryId])
}

// ============================================
// MALADIES DES PATIENTS
// ============================================

// Maladie diagnostiquée chez un patient
model PatientDisease {
  id        Int     @id @default(autoincrement())
  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  diseaseId Int
  disease   Disease @relation(fields: [diseaseId], references: [id])

  diagnosedAt DateTime        @default(now())
  status      DiseaseStatus   @default(ACTIVE)
  severity    DiseaseSeverity @default(MODERATE)
  notes       String?

  // Relations
  symptoms    PatientSymptom[]
  medications PatientMedication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, diseaseId])
}

// Symptômes spécifiques ressentis par un patient
model PatientSymptom {
  id               Int            @id @default(autoincrement())
  patientDisease   PatientDisease @relation(fields: [patientDiseaseId], references: [id], onDelete: Cascade)
  patientDiseaseId Int
  symptom          Symptom        @relation(fields: [symptomId], references: [id])
  symptomId        Int
  intensity        Int            @default(5) // 1-10
  startedAt        DateTime       @default(now())
  endedAt          DateTime?
  notes            String?

  @@unique([patientDiseaseId, symptomId])
}

// ============================================
// PHARMACIES ET MÉDICAMENTS
// ============================================

// Pharmacies (ajoutées par admin)
model Pharmacy {
  id        Int     @id @default(autoincrement())
  name      String
  address   String
  city      String
  countryId Int
  country   Country @relation(fields: [countryId], references: [id])
  phone     String?
  email     String?

  // Relations
  medicines Medicine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Catalogue des médicaments (ajouté par admin)
model Medicine {
  id          Int          @id @default(autoincrement())
  name        String
  type        MedicineType // Pharmaceutique ou Plante médicinale
  description String?
  composition String? // Composition du médicament

  // Si c'est une plante médicinale
  scientificName String? // Nom scientifique de la plante
  commonNames    String[] // Noms communs

  // Si c'est un médicament de pharmacie
  pharmacyId Int?
  pharmacy   Pharmacy? @relation(fields: [pharmacyId], references: [id])

  // Informations générales
  sideEffects       String[] // Effets secondaires
  contraindications String[] // Contre-indications

  // Relations
  patientMedications PatientMedication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Médicaments prescrits à un patient pour une maladie spécifique
model PatientMedication {
  id               Int            @id @default(autoincrement())
  patientDiseaseId Int
  patientDisease   PatientDisease @relation(fields: [patientDiseaseId], references: [id], onDelete: Cascade)
  medicineId       Int
  medicine         Medicine       @relation(fields: [medicineId], references: [id])

  dosage    String // Ex: "500mg"
  frequency String // Ex: "2 fois par jour"
  duration  String? // Ex: "7 jours"
  startDate DateTime  @default(now())
  endDate   DateTime?
  notes     String? // Instructions spéciales

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// ORDONNANCES ET DOSSIERS MÉDICAUX
// ============================================

// Ordonnances globales
model Prescription {
  id        Int     @id @default(autoincrement())
  doctorId  Int
  doctor    Doctor  @relation(fields: [doctorId], references: [id])
  patientId Int
  patient   Patient @relation(fields: [patientId], references: [id])

  medications String // Liste des médicaments
  diagnosis   String? // Diagnostic
  notes       String?

  issuedAt DateTime @default(now())
}

// Dossiers médicaux
model MedicalRecord {
  id        Int      @id @default(autoincrement())
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  patientId Int
  title     String
  content   String
  files     String[] @default([])
  createdAt DateTime @default(now())
}
